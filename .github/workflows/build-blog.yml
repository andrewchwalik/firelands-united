name: Build Blog Posts

on:
  push:
    paths:
      - '_posts/**'
      - '.github/workflows/build-blog.yml'
      - '_templates/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdown parser
        run: npm install marked gray-matter

      - name: Build blog posts
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          const matter = require('gray-matter');
          const { marked } = require('marked');

          const postsDir = '_posts';
          const outputDir = 'blogs';
          const templatePath = '_templates/blog-post.html';
          const blogsJsonPath = 'blogs.json';

          // Read the blog post HTML template
          const template = fs.readFileSync(templatePath, 'utf-8');

          // Ensure output directory exists
          if (!fs.existsSync(outputDir)) {
            fs.mkdirSync(outputDir, { recursive: true });
          }

          // Get all markdown files
          const postFiles = fs.readdirSync(postsDir).filter(f => f.endsWith('.md'));

          const allPosts = [];

          for (const file of postFiles) {
            const raw = fs.readFileSync(path.join(postsDir, file), 'utf-8');
            const { data, content } = matter(raw);

            // Convert markdown body to HTML
            const bodyHtml = marked(content);

            // Format the date
            const dateObj = new Date(data.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });

            // Create the slug from filename
            const slug = file.replace('.md', '');

            // Build the HTML page from template
            let html = template
              .replace(/{{title}}/g, data.title || 'Untitled')
              .replace(/{{date}}/g, formattedDate)
              .replace(/{{category}}/g, data.category || 'Club News')
              .replace(/{{image}}/g, data.image || '/img/blogs/default.jpg')
              .replace(/{{excerpt}}/g, data.excerpt || '')
              .replace(/{{slug}}/g, slug)
              .replace(/{{url}}/g, `https://firelandsunited.com/blogs/${slug}/`)
              .replace(/{{body}}/g, bodyHtml);

            // Write the HTML file
            const postDir = path.join(outputDir, slug);
            if (!fs.existsSync(postDir)) {
              fs.mkdirSync(postDir, { recursive: true });
            }
            fs.writeFileSync(path.join(postDir, 'index.html'), html);

            // Add to posts list for blogs.json
            allPosts.push({
              title: data.title || 'Untitled',
              excerpt: data.excerpt || '',
              link: `/blogs/${slug}/`,
              image: data.image || '/img/blogs/default.jpg',
              category: (data.category || 'Club News').toLowerCase(),
              date: data.date
            });
          }

          // Sort posts by date (newest first)
          allPosts.sort((a, b) => new Date(b.date) - new Date(a.date));

          // Write blogs.json
          fs.writeFileSync(blogsJsonPath, JSON.stringify(allPosts, null, 2));

          console.log(`Built ${allPosts.length} blog posts`);
          console.log('Updated blogs.json');
          SCRIPT

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add blogs/ blogs.json
          git diff --staged --quiet || git commit -m "Auto-build blog posts from markdown"
          git push
